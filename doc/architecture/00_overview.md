# Milicard 系统架构总览

## 1. 项目概述

Milicard 是一个直播带货利润管理系统，涵盖采购、库存、销售、财务等核心业务流程。

### 1.1 核心业务模块
- **基础数据管理** - 直播间、主播、商品、客户
- **库存管理** - 采购、到货、调货、库存消耗
- **销售管理** - 分销、出库
- **财务管理** - 主播利润、应收应付

### 1.2 设计原则
- **AI友好** - 优化代码结构，便于AI理解和维护
- **易维护** - 模块化设计，清晰的代码组织
- **易调试** - 完善的日志系统和错误追踪
- **可扩展** - 支持未来业务增长和功能扩展

## 2. 技术架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    Milicard 系统架构                        │
├─────────────────────────────────────────────────────────────┤
│  前端层 (Presentation Layer)                                │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  Ant Design Pro (React + Umi + TypeScript)             │ │
│  │  - 管理后台界面                                          │ │
│  │  - ProTable/ProForm 组件                               │ │
│  │  - 权限控制和路由管理                                    │ │
│  └─────────────────────────────────────────────────────────┘ │
│                            │ HTTP API                        │
├─────────────────────────────────────────────────────────────┤
│  后端层 (Backend Layer)                                     │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  Express + TypeScript                                   │ │
│  │  ┌─────────────┬─────────────┬─────────────┬───────────┐ │ │
│  │  │ 库存模块     │ 销售模块     │ 财务模块     │ 基础模块   │ │ │
│  │  │ inventory   │ sales       │ finance     │ shared    │ │ │
│  │  └─────────────┴─────────────┴─────────────┴───────────┘ │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │ 中间件层 (Middleware)                                │ │ │
│  │  │ - 认证授权 - 错误处理 - 日志记录 - 权限控制          │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
│                            │ Prisma ORM                      │
├─────────────────────────────────────────────────────────────┤
│  数据层 (Data Layer)                                        │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  PostgreSQL 数据库                                       │ │
│  │  - 业务数据存储                                          │ │
│  │  - 事务支持                                              │ │
│  │  - 并发控制                                              │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  支撑层 (Infrastructure Layer)                              │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  AI友好的开发维护系统                                     │ │
│  │  - 结构化日志 - 错误追踪 - 自动诊断 - 修复建议          │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 技术栈选择

**前端技术栈：**
- **Ant Design Pro** - 企业级管理后台框架
- **React 18** - 用户界面库
- **TypeScript** - 类型安全的JavaScript
- **Umi 4** - 企业级前端应用框架
- **ProComponents** - 高级业务组件

**后端技术栈：**
- **Express** - Node.js Web框架
- **TypeScript** - 类型安全的服务端开发
- **Prisma** - 现代数据库ORM
- **PostgreSQL** - 关系型数据库
- **Winston** - 日志管理

**开发工具：**
- **Docker** - 容器化部署
- **ESLint/Prettier** - 代码规范
- **Jest** - 单元测试
- **Swagger** - API文档

## 3. 架构决策记录

### 3.1 前后端分离 vs 全栈框架

**决策：** 选择前后端分离架构（Ant Design Pro + Express）

**理由：**
- 保持已有的 Ant Design Pro 投入和精美UI
- 职责分明，便于团队协作
- Express 专注API服务，结构简单
- AI友好度高，易于理解和维护

**替代方案：**
- ❌ Next.js Full-Stack - 与现有前端重复
- ❌ Spring Cloud Alibaba - 学习曲线陡峭，AI友好度低

### 3.2 单体 vs 微服务

**决策：** 采用模块化单体架构

**理由：**
- 适合中小型团队（1-5人）
- 系统规模适中（< 100并发用户）
- 降低部署和维护复杂度
- 支持未来微服务拆分

**扩展路径：**
1. 数据库拆分 → 2. 服务拆分 → 3. API网关

### 3.3 数据库选择

**决策：** PostgreSQL + Prisma ORM

**理由：**
- PostgreSQL 功能强大，支持复杂查询
- Prisma 提供类型安全和优秀的开发体验
- 支持事务和并发控制
- AI友好的代码生成

## 4. 核心特性

### 4.1 权限控制系统

**字段级权限控制：**
```typescript
// 基于角色的字段过滤
const rolePermissions = {
  'finance': ['price', 'cost', 'profit'], // 财务可见价格
  'warehouse': ['stock', 'location'],     // 仓管可见库存
  'anchor': ['name', 'description']       // 主播只能看基本信息
}
```

**页面级权限控制：**
- 基于JWT的身份认证
- 角色和权限的灵活配置
- 前后端双重权限验证

### 4.2 AI友好的错误诊断

**结构化日志：**
- 统一的错误格式和上下文信息
- 自动生成AI分析提示
- 一键导出错误报告

**自动化修复建议：**
- 基于错误类型的智能建议
- 完整的修复代码生成
- 预防措施和优化建议

### 4.3 业务流程自动化

**数据同步：**
- 采购单 → 自动生成应付记录
- 分销单 → 自动生成应收记录
- 到货单 → 自动更新库存
- 调货单 → 自动更新消耗记录

**状态流转：**
- 采购单状态管理
- 库存实时计算
- 财务数据自动汇总

## 5. 部署架构

### 5.1 开发环境

```
开发者本地环境
├── client (localhost:8000) - Ant Design Pro
├── server (localhost:3001) - Express API
└── database (localhost:5432) - PostgreSQL
```

### 5.2 生产环境

```
生产环境 (Docker Compose)
├── nginx (端口80) - 反向代理和静态文件服务
├── client (容器) - 构建后的静态文件
├── server (容器) - Express API服务
├── database (容器) - PostgreSQL数据库
└── redis (容器) - 缓存服务
```

## 6. 文档结构

```
doc/
├── architecture/           # 架构文档
│   ├── 00_overview.md     # 总览（本文档）
│   ├── 01_backend_architecture.md    # 后端架构
│   ├── 02_frontend_architecture.md   # 前端架构
│   └── 03_ai_friendly_system.md      # AI友好系统
├── prd/                   # 产品需求文档
│   └── 01_live_base/      # 直播基础模块PRD
└── api/                   # API文档
    └── swagger.json       # API规范
```

## 7. 开发流程

### 7.1 AI辅助开发流程

```
需求分析 → AI生成代码模板 → 开发实现 → 自动测试 → 
错误监控 → AI分析诊断 → 自动修复建议 → 代码优化
```

### 7.2 质量保证

- **代码规范** - ESLint + Prettier 自动格式化
- **类型检查** - TypeScript 静态类型检查
- **单元测试** - Jest 测试框架
- **API测试** - Swagger 文档和测试
- **错误监控** - 实时错误追踪和分析

---

**文档版本：** v1.0  
**创建时间：** 2025-11-16  
**最后更新：** 2025-11-16  
**维护者：** Milicard 开发团队
