# 点位订单系统设计方案

## 一、业务背景

### 1.1 两种"采购"的区别

| 维度 | 基地采购（已实现） | 点位采购（待实现） |
|------|-------------------|-------------------|
| **发起方** | 基地管理员 | 点位老板 |
| **采购对象** | 向外部供应商采购 | 向基地采购 |
| **货物流向** | 供应商 → 基地总仓库 | 基地总仓库 → 点位 |
| **本质** | 进货/入库 | 内部调拨/出库 |
| **对应模块** | PurchaseOrder + ArrivalOrder | **PointOrder（新建）** |

### 1.2 业务流程

```
点位老板下单 → 客服审核 → 从总仓库出库 → 配送 → 货物进入点位库存
     ↓            ↓           ↓          ↓           ↓
  PENDING    CONFIRMED    SHIPPING    DELIVERED   COMPLETED
```

---

## 二、数据模型设计

### 2.1 新增实体

#### 2.1.1 点位 (Point)
点位是线下门店的抽象，属于某个大区（Base，type=OFFLINE_REGION）。

**说明**：
- 一个点位只能属于一个大区
- 一个用户（点位老板）可以管理多个点位（通过 UserPoint 关联表）
- 点位与“小区/仓库”是独立的概念，点位向总仓库发起采购

```prisma
model Point {
  id              String           @id @default(uuid())
  code            String           @unique                    // 点位编号：POINT-XXXXXXXXXXX
  name            String                                      // 店铺名称
  address         String?                                     // 详细地址
  contactPerson   String?          @map("contact_person")     // 联系人
  contactPhone    String?          @map("contact_phone")      // 联系电话
  baseId          Int              @map("base_id")            // 所属大区
  notes           String?
  isActive        Boolean          @default(true) @map("is_active")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  
  base            Base             @relation(fields: [baseId], references: [id])
  userPoints      UserPoint[]      // 管理该点位的用户列表
  pointOrders     PointOrder[]
  pointInventory  PointInventory[]
  pointGoods      PointGoods[]     // 该点位可采购的商品列表

  @@index([code])
  @@index([name])
  @@index([baseId])
  @@index([isActive])
  @@map("points")
}
```

#### 2.1.2 用户点位关联 (UserPoint)
一个用户可以管理多个点位。

```prisma
model UserPoint {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  pointId   String   @map("point_id")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  
  user      User     @relation("UserPoints", fields: [userId], references: [id], onDelete: Cascade)
  point     Point    @relation(fields: [pointId], references: [id], onDelete: Cascade)

  @@unique([userId, pointId])
  @@index([userId])
  @@index([pointId])
  @@map("user_points")
}
```

#### 2.1.3 点位可采购商品 (PointGoods)
控制哪些商品对该点位可见/可采购。

```prisma
model PointGoods {
  id        String   @id @default(uuid())
  pointId   String   @map("point_id")
  goodsId   String   @map("goods_id")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  
  point     Point    @relation(fields: [pointId], references: [id], onDelete: Cascade)
  goods     Goods    @relation(fields: [goodsId], references: [id], onDelete: Cascade)

  @@unique([pointId, goodsId])
  @@index([pointId])
  @@index([goodsId])
  @@map("point_goods")
}
```

#### 2.1.4 点位订单 (PointOrder)
点位老板向基地总仓库下的采购订单。

**说明**：
- 点位老板下单时不显示库存数量（因为可能库存不足，客服可根据需求发起基地采购）
- 价格使用商品零售价（retailPrice）
- 付款状态由客服人工编辑记录

```prisma
model PointOrder {
  id              String            @id @default(uuid())
  code            String            @unique                    // 订单编号：PTO-XXXXXXXXXXX
  pointId         String            @map("point_id")           // 下单点位
  baseId          Int               @map("base_id")            // 所属大区
  orderDate       DateTime          @map("order_date") @db.Date
  totalAmount     Decimal           @default(0) @map("total_amount") @db.Decimal(12, 2)
  status          PointOrderStatus  @default(PENDING)
  
  // 付款信息（人工编辑）
  paymentStatus   PaymentStatus     @default(UNPAID) @map("payment_status")
  paidAmount      Decimal           @default(0) @map("paid_amount") @db.Decimal(12, 2)
  paymentNotes    String?           @map("payment_notes")      // 付款备注
  
  // 配送信息
  shippingAddress String?           @map("shipping_address")
  shippingPhone   String?           @map("shipping_phone")
  trackingNumber  String?           @map("tracking_number")    // 物流单号
  deliveryPerson  String?           @map("delivery_person")    // 送货员
  deliveryPhone   String?           @map("delivery_phone")     // 送货员电话
  
  // 时间节点
  confirmedAt     DateTime?         @map("confirmed_at")       // 客服确认时间
  shippedAt       DateTime?         @map("shipped_at")         // 发货时间
  deliveredAt     DateTime?         @map("delivered_at")       // 送达时间
  completedAt     DateTime?         @map("completed_at")       // 完成时间
  cancelledAt     DateTime?         @map("cancelled_at")       // 取消时间
  
  notes           String?                                      // 订单备注
  customerNotes   String?           @map("customer_notes")     // 客户备注
  staffNotes      String?           @map("staff_notes")        // 客服备注
  
  createdBy       String            @map("created_by")         // 下单人
  confirmedBy     String?           @map("confirmed_by")       // 确认人（客服）
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  
  point           Point             @relation(fields: [pointId], references: [id])
  base            Base              @relation(fields: [baseId], references: [id])
  creator         User              @relation("PointOrderCreator", fields: [createdBy], references: [id])
  confirmer       User?             @relation("PointOrderConfirmer", fields: [confirmedBy], references: [id])
  items           PointOrderItem[]

  @@index([code])
  @@index([pointId])
  @@index([baseId])
  @@index([status])
  @@index([paymentStatus])
  @@index([orderDate])
  @@index([createdBy])
  @@map("point_orders")
}
```

#### 2.1.5 点位订单明细 (PointOrderItem)

```prisma
model PointOrderItem {
  id            String      @id @default(uuid())
  pointOrderId  String      @map("point_order_id")
  goodsId       String      @map("goods_id")
  
  // 订购数量（以盒为最小单位）
  boxQuantity   Int         @default(0) @map("box_quantity")
  packQuantity  Int         @default(0) @map("pack_quantity")   // 盒数
  
  // 单价和总价
  unitPrice     Decimal     @map("unit_price") @db.Decimal(12, 2)  // 单价/盒
  totalPrice    Decimal     @map("total_price") @db.Decimal(12, 2)
  
  // 实际发货数量（客服可调整）
  actualBoxQty  Int?        @map("actual_box_qty")
  actualPackQty Int?        @map("actual_pack_qty")
  
  notes         String?
  
  pointOrder    PointOrder  @relation(fields: [pointOrderId], references: [id], onDelete: Cascade)
  goods         Goods       @relation(fields: [goodsId], references: [id])

  @@index([pointOrderId])
  @@index([goodsId])
  @@map("point_order_items")
}
```

#### 2.1.6 点位库存 (PointInventory)
记录每个点位的库存情况。

```prisma
model PointInventory {
  id            String   @id @default(uuid())
  pointId       String   @map("point_id")
  goodsId       String   @map("goods_id")
  
  // 库存数量
  boxQuantity   Int      @default(0) @map("box_quantity")
  packQuantity  Int      @default(0) @map("pack_quantity")
  pieceQuantity Int      @default(0) @map("piece_quantity")
  
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  point         Point    @relation(fields: [pointId], references: [id], onDelete: Cascade)
  goods         Goods    @relation(fields: [goodsId], references: [id], onDelete: Cascade)

  @@unique([pointId, goodsId])
  @@index([pointId])
  @@index([goodsId])
  @@map("point_inventory")
}
```

#### 2.1.7 枚举定义

```prisma
// 订单状态
enum PointOrderStatus {
  PENDING      // 待处理（老板下单后）
  CONFIRMED    // 已确认（客服确认）
  SHIPPING     // 配送中（已发货）
  DELIVERED    // 已送达
  COMPLETED    // 已完成（货物入点位库存）
  CANCELLED    // 已取消
}

// 付款状态
enum PaymentStatus {
  UNPAID       // 未付款
  PARTIAL      // 部分付款
  PAID         // 已付款
}
```

---

## 三、API 设计

### 3.1 点位管理 API

| 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|
| GET | `/api/v1/bases/:baseId/points` | 获取大区下的点位列表 | 管理员/客服 |
| POST | `/api/v1/bases/:baseId/points` | 创建点位 | 管理员 |
| GET | `/api/v1/bases/:baseId/points/:pointId` | 获取点位详情 | 管理员/客服/点位老板 |
| PUT | `/api/v1/bases/:baseId/points/:pointId` | 更新点位信息 | 管理员 |
| DELETE | `/api/v1/bases/:baseId/points/:pointId` | 删除点位 | 管理员 |

### 3.2 点位可采购商品 API

| 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|
| GET | `/api/v1/points/:pointId/goods` | 获取点位可采购商品 | 点位老板 |
| POST | `/api/v1/points/:pointId/goods` | 添加可采购商品 | 管理员 |
| DELETE | `/api/v1/points/:pointId/goods/:goodsId` | 移除可采购商品 | 管理员 |
| POST | `/api/v1/points/:pointId/goods/batch` | 批量设置可采购商品 | 管理员 |

### 3.3 点位订单 API

| 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|
| GET | `/api/v1/points/:pointId/orders` | 获取点位订单列表 | 点位老板 |
| POST | `/api/v1/points/:pointId/orders` | 创建订单（下单） | 点位老板 |
| GET | `/api/v1/points/:pointId/orders/:orderId` | 获取订单详情 | 点位老板/客服 |
| PUT | `/api/v1/points/:pointId/orders/:orderId` | 更新订单（客服调整） | 客服 |
| POST | `/api/v1/points/:pointId/orders/:orderId/confirm` | 确认订单 | 客服 |
| POST | `/api/v1/points/:pointId/orders/:orderId/ship` | 发货 | 客服 |
| POST | `/api/v1/points/:pointId/orders/:orderId/deliver` | 确认送达 | 客服/点位老板 |
| POST | `/api/v1/points/:pointId/orders/:orderId/complete` | 完成订单 | 客服 |
| POST | `/api/v1/points/:pointId/orders/:orderId/cancel` | 取消订单 | 客服/点位老板 |

### 3.4 客服端订单管理 API

| 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|
| GET | `/api/v1/bases/:baseId/point-orders` | 获取大区所有点位订单 | 客服/管理员 |
| GET | `/api/v1/bases/:baseId/point-orders/pending` | 获取待处理订单 | 客服 |
| GET | `/api/v1/bases/:baseId/point-orders/stats` | 订单统计 | 客服/管理员 |

### 3.5 点位库存 API

| 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|
| GET | `/api/v1/points/:pointId/inventory` | 获取点位库存 | 点位老板/客服 |
| PUT | `/api/v1/points/:pointId/inventory/:goodsId` | 更新点位库存（人工盘点） | 客服 |

---

## 四、前端页面设计

### 4.1 管理端页面（线下区域模块）

#### 4.1.1 点位信息管理
- **路径**: `/offline-region/points`
- **功能**: 
  - 点位列表（支持搜索、筛选）
  - 新建/编辑点位
  - 设置点位可采购商品
  - 关联点位老板账号

#### 4.1.2 点位订单管理
- **路径**: `/offline-region/point-orders`
- **功能**:
  - 订单列表（按状态筛选：待处理/已确认/配送中/已完成）
  - 订单详情查看
  - 确认订单、调整数量
  - 发货操作（填写物流信息）
  - 确认送达、完成订单

#### 4.1.3 点位库存查看
- **路径**: `/offline-region/point-inventory`
- **功能**:
  - 查看各点位库存情况
  - 人工更新库存（盘点）

#### 4.1.4 点位利润统计
- **路径**: `/offline-region/point-profit`
- **功能**:
  - 按点位、日期范围统计
  - 拿货金额、利润金额、利润比

### 4.2 点位老板端页面（独立入口）

#### 4.2.1 商品浏览
- **路径**: `/point-portal/goods`
- **功能**:
  - 浏览可采购商品
  - 商品详情（图片、价格、规格）
  - 加入购物车

#### 4.2.2 购物车
- **路径**: `/point-portal/cart`
- **功能**:
  - 查看购物车
  - 调整数量
  - 提交订单

#### 4.2.3 我的订单
- **路径**: `/point-portal/orders`
- **功能**:
  - 订单列表
  - 订单详情
  - 订单状态跟踪

#### 4.2.4 我的库存
- **路径**: `/point-portal/inventory`
- **功能**:
  - 查看当前库存

---

## 五、与现有系统的集成

### 5.1 库存联动

当订单状态变为 `SHIPPING`（发货）时：
1. 从基地总仓库扣减库存（InventoryLedger）
2. 生成出库记录

当订单状态变为 `COMPLETED`（完成）时：
1. 增加点位库存（PointInventory）

### 5.2 数据打通

- **商品数据**: 点位可采购商品来自基地商品表（Goods）
- **库存数据**: 点位老板看到的库存数量来自基地总仓库
- **价格数据**: 使用商品的零售价（retailPrice）或单独设置点位价格

### 5.3 权限控制

新增角色：
- **POINT_OWNER**: 点位老板，只能访问自己点位的数据
- **POINT_STAFF**: 客服，可以管理所有点位订单

---

## 六、实施计划

### 第一阶段：基础设施（2-3天）
1. 数据库迁移：新增 Point、PointGoods、PointOrder、PointOrderItem、PointInventory 表
2. 后端 API：点位 CRUD、点位商品管理
3. 前端页面：点位信息管理

### 第二阶段：订单系统（3-4天）
1. 后端 API：订单创建、状态流转、库存联动
2. 前端页面：订单管理（管理端）
3. 测试：订单流程测试

### 第三阶段：点位老板端（2-3天）
1. 前端页面：商品浏览、购物车、下单、订单查看
2. 权限控制：点位老板只能访问自己的数据
3. 测试：端到端测试

### 第四阶段：统计报表（1-2天）
1. 点位利润统计
2. 订单统计报表

---

## 七、技术要点

### 7.1 编号生成
- 点位编号：`POINT-XXXXXXXXXXX`
- 点位订单编号：`PTO-XXXXXXXXXXX`

### 7.2 状态机
```
PENDING → CONFIRMED → SHIPPING → DELIVERED → COMPLETED
    ↓         ↓          ↓           ↓
 CANCELLED CANCELLED  CANCELLED   CANCELLED
```

### 7.3 库存扣减时机
- 发货时扣减总仓库库存（而非下单时）
- 避免超卖：发货前检查库存是否充足

### 7.4 价格策略
- 默认使用商品零售价
- 可扩展：支持点位专属价格、折扣

---

## 八、已确认事项

1. **点位老板账号**: 复用现有用户系统，通过权限控制点位老板只能看到部分系统
2. **付款状态**: 需要记录，前期人工编辑记录（不支持多次付款，直接在订单上记录）
3. **到货图片上传**: 暂不需要
4. **多语言**: 整套系统支持，细节后续补齐
5. **点位归属**: 一个点位只能属于一个大区，一个用户可管理多个点位
6. **商品价格**: 前期直接使用商品零售价（retailPrice）
7. **库存显示**: 点位老板下单时不显示库存数量，客服可根据需求发起基地采购
8. **点位概念**: 点位是独立于"小区/仓库"的新概念，点位向总仓库发起采购
9. **用户管理**: 新增"系统管理"菜单，包含用户管理、角色管理
10. **角色管理**: 前期使用预置角色数据，角色管理页面后续开发
11. **账号创建流程**: 方案B，先在用户管理创建用户并分配角色，再在点位信息页面关联用户到点位

---

*文档版本: v1.2*
*创建日期: 2025-12-02*
*更新日期: 2025-12-02*
