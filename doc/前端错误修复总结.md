# å‰ç«¯é”™è¯¯ä¿®å¤æ€»ç»“

## ğŸ› **é‡åˆ°çš„é—®é¢˜**

### 1. **Ant Design åºŸå¼ƒè­¦å‘Š**
```
Warning: [antd: Input] `addonAfter` is deprecated. Please use `Space.Compact` instead.
```

### 2. **401 è®¤è¯é”™è¯¯**
```
GET http://localhost:8000/api/v1/bases/1/personnel?current=1&pageSize=20 401 (Unauthorized)
```

### 3. **Base64ç¼–ç é”™è¯¯**
```
InvalidCharacterError: Failed to execute 'btoa' on 'Window': The string to be encoded contains characters outside of the Latin1 range.
```

### 4. **ç«¯å£é…ç½®é—®é¢˜**
- å‰ç«¯è¯·æ±‚å‘é€åˆ°8000ç«¯å£
- åç«¯è¿è¡Œåœ¨6801ç«¯å£
- ä»£ç†é…ç½®ä¸åŒ¹é…

## âœ… **ä¿®å¤æ–¹æ¡ˆ**

### **1. ä¿®å¤ Ant Design åºŸå¼ƒè­¦å‘Š**

**é—®é¢˜åŸå› **ï¼šSearchç»„ä»¶çš„`enterButton`å±æ€§å†…éƒ¨ä½¿ç”¨äº†å·²åºŸå¼ƒçš„`addonAfter`

**ä¿®å¤æ–¹æ³•**ï¼šä½¿ç”¨`Space.Compact`ç»„åˆ`Input`å’Œ`Button`æ›¿ä»£`Search`ç»„ä»¶

```typescript
// ä¿®å¤å‰
<Search
  placeholder="æœç´¢å§“åæˆ–ç¼–å·"
  allowClear
  enterButton={<SearchOutlined />}
  onSearch={handleSearch}
/>

// ä¿®å¤å
<Space.Compact style={{ width: '100%' }}>
  <Input
    placeholder="æœç´¢å§“åæˆ–ç¼–å·"
    allowClear
    value={searchText}
    onChange={(e) => setSearchText(e.target.value)}
    onPressEnter={() => handleSearch(searchText)}
  />
  <Button 
    type="primary" 
    icon={<SearchOutlined />}
    onClick={() => handleSearch(searchText)}
  />
</Space.Compact>
```

### **2. è§£å†³è®¤è¯é—®é¢˜**

**é—®é¢˜åŸå› **ï¼šå‰ç«¯æ²¡æœ‰æœ‰æ•ˆçš„è®¤è¯tokenï¼Œå¯¼è‡´APIè¯·æ±‚è¿”å›401

**ä¿®å¤æ–¹æ³•**ï¼š
1. åˆ›å»ºè®¤è¯å·¥å…·å‡½æ•° (`client/src/utils/auth.ts`)
2. åœ¨é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è®¤è¯çŠ¶æ€
3. å¦‚æœæœªè®¤è¯ï¼Œè‡ªåŠ¨åˆ›å»ºæ¨¡æ‹Ÿtokenç”¨äºå¼€å‘æµ‹è¯•

```typescript
// è®¤è¯æ£€æŸ¥é€»è¾‘
useEffect(() => {
  // æ£€æŸ¥è®¤è¯çŠ¶æ€
  if (!isAuthenticated()) {
    console.warn('ç”¨æˆ·æœªè®¤è¯ï¼Œåˆ›å»ºæ¨¡æ‹Ÿtoken');
    const mockToken = createMockToken();
    setToken(mockToken);
    message.info('å·²åˆ›å»ºä¸´æ—¶è®¤è¯tokenï¼Œç”¨äºå¼€å‘æµ‹è¯•');
  }
  
  if (currentBase) {
    fetchPersonnelData();
  }
}, [currentBase, pagination.current, pagination.pageSize, searchText, roleFilter, statusFilter]);
```

### **3. ä¿®å¤Base64ç¼–ç é”™è¯¯**

**é—®é¢˜åŸå› **ï¼š`btoa`å‡½æ•°ä¸èƒ½å¤„ç†åŒ…å«ä¸­æ–‡å­—ç¬¦çš„å­—ç¬¦ä¸²ï¼Œåœ¨`createMockToken`å‡½æ•°ä¸­ä½¿ç”¨äº†ä¸­æ–‡"ç®¡ç†å‘˜"

**ä¿®å¤æ–¹æ³•**ï¼š
1. ä½¿ç”¨è‹±æ–‡å­—ç¬¦æ›¿ä»£ä¸­æ–‡å­—ç¬¦
2. æ·»åŠ å®‰å…¨çš„Base64ç¼–ç å‡½æ•°å¤„ç†Unicodeå­—ç¬¦

```typescript
// ä¿®å¤å‰
const payload = btoa(JSON.stringify({
  displayName: 'ç®¡ç†å‘˜', // ä¸­æ–‡å­—ç¬¦å¯¼è‡´ç¼–ç é”™è¯¯
  // ...
}));

// ä¿®å¤å
function safeBase64Encode(str: string): string {
  try {
    return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => {
      return String.fromCharCode(parseInt(p1, 16));
    }));
  } catch (error) {
    // é™çº§å¤„ç†ï¼Œä½¿ç”¨çº¯ASCIIå­—ç¬¦
    return btoa(JSON.stringify({
      displayName: 'Administrator', // ä½¿ç”¨è‹±æ–‡
      // ...
    }));
  }
}

const payload = safeBase64Encode(JSON.stringify({
  displayName: 'Administrator', // ä½¿ç”¨è‹±æ–‡é¿å…ç¼–ç é—®é¢˜
  // ...
}));
```

### **4. ä¿®å¤ç«¯å£é…ç½®**

**é—®é¢˜åŸå› **ï¼šUmiJSä¸æ”¯æŒ`devServer`å’Œ`port`é…ç½®é¡¹

**ä¿®å¤æ–¹æ³•**ï¼šåœ¨package.jsonçš„å¯åŠ¨è„šæœ¬ä¸­ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°

```json
// package.json
{
  "scripts": {
    "start": "cross-env UMI_ENV=dev max dev --port 3000",
    "start:dev": "cross-env REACT_APP_ENV=dev MOCK=none UMI_ENV=dev max dev --port 3000"
  }
}
```

### **5. åˆ›å»ºå¼€å‘ç¯å¢ƒè®¤è¯ç³»ç»Ÿ**

**é—®é¢˜åŸå› **ï¼šå‰ç«¯è·å–çš„å¼€å‘tokenæ— æ³•é€šè¿‡åç«¯JWTéªŒè¯ï¼Œå› ä¸ºæ•°æ®åº“ä¸­ä¸å­˜åœ¨å¯¹åº”çš„ç”¨æˆ·

**ä¿®å¤æ–¹æ³•**ï¼š
1. åˆ›å»ºå¼€å‘ç¯å¢ƒä¸“ç”¨APIç«¯ç‚¹ `/api/v1/dev/token`
2. è‡ªåŠ¨åˆ›å»ºå¼€å‘ç”¨æˆ·å’Œç®¡ç†å‘˜è§’è‰²
3. ç”ŸæˆçœŸæ­£çš„JWT tokenä¾›å‰ç«¯ä½¿ç”¨

```typescript
// åç«¯å¼€å‘è·¯ç”± (server/src/routes/devRoutes.ts)
router.post('/token', async (req: Request, res: Response) => {
  // åªåœ¨å¼€å‘ç¯å¢ƒä¸‹å¯ç”¨
  if (process.env.NODE_ENV !== 'development') {
    return res.status(404).json({ success: false, message: 'Not found' });
  }

  // ç¡®ä¿å¼€å‘ç”¨æˆ·å’Œè§’è‰²å­˜åœ¨
  let devUser = await prisma.user.findUnique({ where: { id: 'dev-user-001' } });
  if (!devUser) {
    // è‡ªåŠ¨åˆ›å»ºå¼€å‘ç”¨æˆ·å’ŒADMINè§’è‰²
    // ...åˆ›å»ºé€»è¾‘
  }

  // ç”ŸæˆçœŸæ­£çš„JWT token
  const token = JwtService.generateAccessToken(payload);
  res.json({ success: true, data: { token, user: payload } });
});
```

```typescript
// å‰ç«¯è®¤è¯é€»è¾‘ (client/src/utils/auth.ts)
export async function getDevToken(): Promise<string | null> {
  const response = await fetch('/api/v1/dev/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: 'developer' })
  });
  
  if (response.ok) {
    const data = await response.json();
    return data.data?.token || null;
  }
  return null;
}
```

## ğŸ”§ **æŠ€æœ¯æ”¹è¿›**

### **1. è®¤è¯å·¥å…·å‡½æ•°**
- `getToken()` - è·å–æœ¬åœ°å­˜å‚¨çš„token
- `setToken()` - è®¾ç½®tokenåˆ°æœ¬åœ°å­˜å‚¨
- `isAuthenticated()` - æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
- `getCurrentUser()` - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- `createMockToken()` - åˆ›å»ºæ¨¡æ‹Ÿtokenç”¨äºå¼€å‘

### **2. ç»Ÿä¸€çš„APIè¯·æ±‚å·¥å…·**
- è‡ªåŠ¨æ·»åŠ è®¤è¯å¤´
- ç»Ÿä¸€é”™è¯¯å¤„ç†
- æ”¯æŒå‚æ•°åºåˆ—åŒ–

### **3. å¼€å‘ç¯å¢ƒé…ç½®**
- æ˜ç¡®çš„ç«¯å£é…ç½®
- æ­£ç¡®çš„ä»£ç†è®¾ç½®
- å¼€å‘å‹å¥½çš„é”™è¯¯æç¤º

## ğŸš€ **éªŒè¯æ­¥éª¤**

### **1. å¯åŠ¨åç«¯æœåŠ¡**
```bash
cd server
npm run dev
# åº”è¯¥åœ¨ http://localhost:6801 å¯åŠ¨
```

### **2. å¯åŠ¨å‰ç«¯æœåŠ¡**
```bash
cd client
npm start
# åº”è¯¥åœ¨ http://localhost:3000 å¯åŠ¨
```

### **3. æµ‹è¯•APIè¿æ¥**
```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ
node test-api.js
```

### **4. éªŒè¯åŠŸèƒ½**
1. è®¿é—® http://localhost:3000
2. è¿›å…¥ä¸»æ’­/ä»“ç®¡é¡µé¢
3. æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦è¿˜æœ‰è­¦å‘Š
4. å°è¯•åˆ›å»ºæ–°çš„äººå‘˜è®°å½•
5. åˆ‡æ¢é¡µé¢åè¿”å›ï¼ŒéªŒè¯æ•°æ®æŒä¹…æ€§

## ğŸ“‹ **å½“å‰çŠ¶æ€**

âœ… **å·²ä¿®å¤**ï¼š
- Ant Design åºŸå¼ƒè­¦å‘Š
- Base64ç¼–ç é”™è¯¯ï¼ˆUnicodeå­—ç¬¦é—®é¢˜ï¼‰
- 401è®¤è¯é”™è¯¯ï¼ˆåˆ›å»ºå¼€å‘ç¯å¢ƒtokenç«¯ç‚¹ï¼‰
- å‰ç«¯ç«¯å£é…ç½®
- APIè¯·æ±‚è®¤è¯å¤´
- å¼€å‘ç¯å¢ƒç”¨æˆ·å’Œè§’è‰²è‡ªåŠ¨åˆ›å»º

âœ… **å·²ä¼˜åŒ–**ï¼š
- æœç´¢ç»„ä»¶ä½¿ç”¨ç°ä»£API
- è‡ªåŠ¨è®¤è¯æ£€æŸ¥
- å¼€å‘ç¯å¢ƒå‹å¥½æç¤º
- ç»Ÿä¸€çš„è¯·æ±‚å·¥å…·

## ğŸ¯ **åç»­å»ºè®®**

### **1. ç”Ÿäº§ç¯å¢ƒè®¤è¯**
- å®ç°çœŸå®çš„ç™»å½•é¡µé¢
- é›†æˆJWTè®¤è¯æµç¨‹
- æ·»åŠ tokenè‡ªåŠ¨åˆ·æ–°

### **2. é”™è¯¯å¤„ç†ä¼˜åŒ–**
- å…¨å±€é”™è¯¯è¾¹ç•Œ
- ç½‘ç»œé”™è¯¯é‡è¯•
- ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º

### **3. å¼€å‘ä½“éªŒæå‡**
- çƒ­é‡è½½ä¼˜åŒ–
- å¼€å‘å·¥å…·é›†æˆ
- è‡ªåŠ¨åŒ–æµ‹è¯•

ç°åœ¨å‰ç«¯åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œä¸å†æœ‰Ant Designè­¦å‘Šå’Œè®¤è¯é”™è¯¯ï¼
