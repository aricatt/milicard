generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl", "debian-openssl-3.0.x"]
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
  // 连接池配置：防止连接泄漏
  // connection_limit: 最大连接数
  // pool_timeout: 连接池超时时间（秒）
}

model User {
  id                   String              @id @default(uuid())
  username             String              @unique
  email                String?             @unique
  passwordHash         String              @map("password_hash")
  name                 String
  phone                String?
  isActive             Boolean             @default(true) @map("is_active")
  lastLoginAt          DateTime?           @map("last_login_at")
  defaultBaseId        Int?                @map("default_base_id")
  createdAt            DateTime            @default(now()) @map("created_at")
  updatedAt            DateTime            @updatedAt @map("updated_at")
  anchorProfits        AnchorProfit[]      @relation("AnchorProfitCreator")
  arrivalOrders        ArrivalOrder[]      @relation("ArrivalOrderCreator")
  createdArrivals      ArrivalRecord[]     @relation("ArrivalCreator")
  updatedArrivals      ArrivalRecord[]     @relation("ArrivalUpdater")
  stockOuts            StockOut[]          @relation("StockOutCreator")
  createdGoods         Goods[]             @relation("GoodsCreator")
  updatedGoods         Goods[]             @relation("GoodsUpdater")
  createdLedgers       InventoryLedger[]   @relation("InventoryLedgerCreator")
  updatedLedgers       InventoryLedger[]   @relation("InventoryLedgerUpdater")
  payablePayments      PayablePayment[]    @relation("PayablePaymentCreator")
  payables             Payable[]           @relation("PayableCreator")
  createdPersonnel     Personnel[]         @relation("PersonnelCreator")
  updatedPersonnel     Personnel[]         @relation("PersonnelUpdater")
  purchaseOrders       PurchaseOrder[]     @relation("PurchaseOrderCreator")
  stockConsumptions    StockConsumption[]  @relation("StockConsumptionCreator")
  transferOrders       TransferOrder[]     @relation("TransferOrderCreator")
  createdTransfers     TransferRecord[]    @relation("TransferCreator")
  updatedTransfers     TransferRecord[]    @relation("TransferUpdater")
  translationReviews   TranslationReview[] @relation("TranslationReviewer")
  createdTranslations  Translation[]       @relation("TranslationCreator")
  updatedTranslations  Translation[]       @relation("TranslationUpdater")
  userBases            UserBase[]
  userLocations        UserLocation[]
  userRoles            UserRole[]
  defaultBase          Base?               @relation("UserDefaultBase", fields: [defaultBaseId], references: [id])
  // 点位订单系统关联
  ownedPoints          Point[]             @relation("PointOwner")
  dealerPoints         Point[]             @relation("PointDealer")
  createdPointOrders   PointOrder[]        @relation("PointOrderCreator")
  confirmedPointOrders PointOrder[]        @relation("PointOrderConfirmer")

  @@index([username])
  @@index([email])
  @@index([isActive])
  @@index([defaultBaseId])
  @@map("users")
}

model Role {
  id             String   @id @default(uuid())
  name           String   @unique
  description    String?
  level          Int      @default(99) // 角色层级：0=最高权限，数字越大权限越低
  permissions    Json     @default("[]")
  isSystem       Boolean  @default(false) @map("is_system")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  descriptionKey String?  @map("description_key")
  nameKey        String?  @map("name_key")

  userRoles           UserRole[]
  dataPermissionRules DataPermissionRule[]
  fieldPermissions    FieldPermission[]

  @@index([name])
  @@index([nameKey])
  @@index([isSystem])
  @@index([level])
  @@map("roles")
}

model UserRole {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  roleId     String    @map("role_id")
  assignedBy String    @map("assigned_by")
  assignedAt DateTime  @default(now()) @map("assigned_at")
  expiresAt  DateTime? @map("expires_at")
  isActive   Boolean   @default(true) @map("is_active")
  role       Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId, isActive], name: "uk_user_role_active")
  @@index([userId])
  @@index([roleId])
  @@index([expiresAt])
  @@index([isActive])
  @@map("user_roles")
}

model Location {
  id                   Int                @id @default(autoincrement())
  name                 String
  type                 LocationType
  description          String?
  address              String?
  contactPerson        String?            @map("contact_person")
  contactPhone         String?            @map("contact_phone")
  baseId               Int                @map("base_id")
  isActive             Boolean            @default(true) @map("is_active")
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")
  code                 String             @unique
  anchorProfits        AnchorProfit[]
  arrivalOrders        ArrivalOrder[]
  arrivalRecords       ArrivalRecord[]
  inventoryLedgers     InventoryLedger[]  @relation("InventoryLedgerLocation")
  base                 Base               @relation(fields: [baseId], references: [id])
  purchaseOrders       PurchaseOrder[]    @relation("PurchaseOrderTarget")
  stockConsumptions    StockConsumption[]
  stockOuts            StockOut[]
  transferOrdersFrom   TransferOrder[]    @relation("TransferOrderFrom")
  transferOrdersTo     TransferOrder[]    @relation("TransferOrderTo")
  transferDestinations TransferRecord[]   @relation("TransferDestination")
  transferSources      TransferRecord[]   @relation("TransferSource")
  userLocations        UserLocation[]

  @@index([name])
  @@index([type])
  @@index([isActive])
  @@map("locations")
}

model UserLocation {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  locationId Int      @map("location_id")
  createdAt  DateTime @default(now()) @map("created_at")
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, locationId])
  @@index([userId])
  @@index([locationId])
  @@map("user_locations")
}

model Customer {
  id                 String              @id @default(uuid())
  name               String
  contactPerson      String?             @map("contact_person")
  phone              String?
  email              String?
  address            String?
  notes              String?
  baseId             Int?                @map("base_id")
  isActive           Boolean             @default(true) @map("is_active")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  base               Base?               @relation(fields: [baseId], references: [id])

  @@index([phone])
  @@index([isActive])
  @@index([name])
  @@map("customers")
}

model Goods {
  id                     String                  @id @default(uuid())
  code                   String                  @unique
  name                   String
  description            String?
  retailPrice            Decimal                 @map("retail_price") @db.Decimal(12, 2)
  purchasePrice          Decimal?                @map("purchase_price") @db.Decimal(12, 2)
  boxQuantity            Int                     @default(1) @map("box_quantity")
  packPerBox             Int                     @map("pack_per_box")
  piecePerPack           Int                     @map("piece_per_pack")
  imageUrl               String?                 @map("image_url")
  notes                  String?
  isActive               Boolean                 @default(true) @map("is_active")
  createdAt              DateTime                @default(now()) @map("created_at")
  updatedAt              DateTime                @updatedAt @map("updated_at")
  alias                  String?
  manufacturer           String
  packPrice              Decimal?                @map("pack_price") @db.Decimal(12, 2)
  baseId                 Int                     @map("base_id")
  createdBy              String?                 @map("created_by")
  updatedBy              String?                 @map("updated_by")
  arrivalOrderItems      ArrivalOrderItem[]
  arrivalRecords         ArrivalRecord[]
  base                   Base                    @relation(fields: [baseId], references: [id], onDelete: Cascade)
  creator                User?                   @relation("GoodsCreator", fields: [createdBy], references: [id])
  updater                User?                   @relation("GoodsUpdater", fields: [updatedBy], references: [id])
  inventory              Inventory[]
  inventoryLedgers       InventoryLedger[]
  purchaseOrderItems     PurchaseOrderItem[]
  stockConsumptions      StockConsumption[]
  stockOuts              StockOut[]
  transferOrderItems     TransferOrderItem[]
  transferRecords        TransferRecord[]
  // 点位订单系统关联
  pointGoods             PointGoods[]
  pointOrderItems        PointOrderItem[]
  pointInventory         PointInventory[]

  @@index([code])
  @@index([name])
  @@index([baseId])
  @@index([isActive])
  @@index([baseId, isActive])
  @@map("goods")
}

// 商品成本表：存储每个商品的移动加权平均成本
model Inventory {
  id          String   @id @default(uuid())
  goodsId     String   @map("goods_id")
  baseId      Int      @map("base_id")
  averageCost Decimal  @default(0) @map("average_cost") @db.Decimal(12, 2)
  updatedAt   DateTime @updatedAt @map("updated_at")
  base        Base     @relation(fields: [baseId], references: [id])
  goods       Goods    @relation(fields: [goodsId], references: [id], onDelete: Cascade)

  @@unique([goodsId, baseId])
  @@index([goodsId])
  @@index([baseId])
  @@map("inventory")
}

model PurchaseOrder {
  id               String              @id @default(uuid())
  code             String              @unique
  supplierId       String              @map("supplier_id")
  targetLocationId Int?                @map("target_location_id")
  baseId           Int                 @map("base_id")
  purchaseDate     DateTime            @map("purchase_date") @db.Date
  totalAmount      Decimal             @default(0) @map("total_amount") @db.Decimal(12, 2)
  notes            String?
  createdBy        String              @map("created_by")
  createdAt        DateTime            @default(now()) @map("created_at")
  updatedAt        DateTime            @updatedAt @map("updated_at")
  actualAmount     Decimal?            @map("actual_amount") @db.Decimal(12, 2)
  arrivalOrders    ArrivalOrder[]
  arrivalRecords   ArrivalRecord[]
  payables         Payable[]
  items            PurchaseOrderItem[]
  base             Base                @relation(fields: [baseId], references: [id])
  creator          User                @relation("PurchaseOrderCreator", fields: [createdBy], references: [id])
  targetLocation   Location?           @relation("PurchaseOrderTarget", fields: [targetLocationId], references: [id])
  supplier         Supplier            @relation(fields: [supplierId], references: [id])

  @@index([code])
  @@index([supplierId])
  @@index([targetLocationId])
  @@index([baseId])
  @@index([purchaseDate])
  @@index([createdBy])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String        @map("purchase_order_id")
  goodsId         String        @map("goods_id")
  boxQuantity     Int           @default(0) @map("box_quantity")
  packQuantity    Int           @default(0) @map("pack_quantity")
  pieceQuantity   Int           @default(0) @map("piece_quantity")
  totalPieces     Int           @map("total_pieces")
  unitPrice       Decimal       @map("unit_price") @db.Decimal(12, 2)
  totalPrice      Decimal       @map("total_price") @db.Decimal(12, 2)
  notes           String?
  goods           Goods         @relation(fields: [goodsId], references: [id])
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
  @@index([goodsId])
  @@map("purchase_order_items")
}

model ArrivalOrder {
  id              String             @id @default(uuid())
  code            String             @unique
  purchaseOrderId String             @map("purchase_order_id")
  locationId      Int                @map("location_id")
  arrivalDate     DateTime           @map("arrival_date") @db.Date
  notes           String?
  createdBy       String             @map("created_by")
  createdAt       DateTime           @default(now()) @map("created_at")
  items           ArrivalOrderItem[]
  creator         User               @relation("ArrivalOrderCreator", fields: [createdBy], references: [id])
  location        Location           @relation(fields: [locationId], references: [id])
  purchaseOrder   PurchaseOrder      @relation(fields: [purchaseOrderId], references: [id])

  @@index([code])
  @@index([purchaseOrderId])
  @@index([locationId])
  @@index([arrivalDate])
  @@map("arrival_orders")
}

model ArrivalOrderItem {
  id             String       @id @default(uuid())
  arrivalOrderId String       @map("arrival_order_id")
  goodsId        String       @map("goods_id")
  quantity       Int
  unitCost       Decimal      @map("unit_cost") @db.Decimal(12, 2)
  notes          String?
  arrivalOrder   ArrivalOrder @relation(fields: [arrivalOrderId], references: [id], onDelete: Cascade)
  goods          Goods        @relation(fields: [goodsId], references: [id])

  @@index([arrivalOrderId])
  @@index([goodsId])
  @@map("arrival_order_items")
}

model TransferOrder {
  id             String              @id @default(uuid())
  code           String              @unique
  fromLocationId Int                 @map("from_location_id")
  toLocationId   Int                 @map("to_location_id")
  transferDate   DateTime            @map("transfer_date") @db.Date
  notes          String?
  createdBy      String              @map("created_by")
  createdAt      DateTime            @default(now()) @map("created_at")
  items          TransferOrderItem[]
  creator        User                @relation("TransferOrderCreator", fields: [createdBy], references: [id])
  fromLocation   Location            @relation("TransferOrderFrom", fields: [fromLocationId], references: [id])
  toLocation     Location            @relation("TransferOrderTo", fields: [toLocationId], references: [id])

  @@index([code])
  @@index([fromLocationId])
  @@index([toLocationId])
  @@index([transferDate])
  @@map("transfer_orders")
}

model TransferOrderItem {
  id              String        @id @default(uuid())
  transferOrderId String        @map("transfer_order_id")
  goodsId         String        @map("goods_id")
  quantity        Int
  notes           String?
  goods           Goods         @relation(fields: [goodsId], references: [id])
  transferOrder   TransferOrder @relation(fields: [transferOrderId], references: [id], onDelete: Cascade)

  @@index([transferOrderId])
  @@index([goodsId])
  @@map("transfer_order_items")
}

model StockConsumption {
  id              String   @id @default(uuid())
  consumptionDate DateTime @map("consumption_date") @db.Date
  goodsId         String   @map("goods_id")
  locationId      Int      @map("location_id")
  handlerId       String   @map("handler_id")
  baseId          Int      @map("base_id")
  // 期初（调入总量）
  openingBoxQty   Int      @default(0) @map("opening_box_qty")
  openingPackQty  Int      @default(0) @map("opening_pack_qty")
  openingPieceQty Int      @default(0) @map("opening_piece_qty")
  // 期末（用户填写的剩余）
  closingBoxQty   Int      @default(0) @map("closing_box_qty")
  closingPackQty  Int      @default(0) @map("closing_pack_qty")
  closingPieceQty Int      @default(0) @map("closing_piece_qty")
  // 消耗（期初-期末）
  boxQuantity     Int      @default(0) @map("box_quantity")
  packQuantity    Int      @default(0) @map("pack_quantity")
  pieceQuantity   Int      @default(0) @map("piece_quantity")
  // 平均单价/箱（快照，从Inventory获取）
  unitPricePerBox Decimal  @default(0) @map("unit_price_per_box") @db.Decimal(12, 2)
  notes           String?
  createdBy       String   @map("created_by")
  updatedBy       String?  @map("updated_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  goods        Goods         @relation(fields: [goodsId], references: [id])
  location     Location      @relation(fields: [locationId], references: [id])
  handler      Personnel     @relation("ConsumptionHandler", fields: [handlerId], references: [id])
  base         Base          @relation(fields: [baseId], references: [id])
  creator      User          @relation("StockConsumptionCreator", fields: [createdBy], references: [id])
  anchorProfit AnchorProfit?

  @@unique([consumptionDate, goodsId, locationId, handlerId])
  @@index([baseId])
  @@index([locationId])
  @@index([goodsId])
  @@index([handlerId])
  @@index([consumptionDate])
  @@map("stock_consumption")
}

/// 出库类型
enum StockOutType {
  POINT_ORDER  // 点位发货（自动创建）
  TRANSFER     // 跨基地调货（预留）
  MANUAL       // 手动出库
}

/// 出库记录（单商品单记录）
model StockOut {
  id               String       @id @default(uuid())
  baseId           Int          @map("base_id")
  date             DateTime     @db.Date
  goodsId          String       @map("goods_id")
  type             StockOutType @default(MANUAL)
  targetName       String?      @map("target_name")      // 目标名称（点位名/基地名等）
  relatedOrderId   String?      @map("related_order_id") // 关联订单ID（点位订单等）
  relatedOrderCode String?      @map("related_order_code") // 关联订单编号
  locationId       Int          @map("location_id")      // 出库仓库
  boxQuantity      Int          @default(0) @map("box_quantity")   // 出库/箱
  packQuantity     Int          @default(0) @map("pack_quantity")  // 出库/盒
  pieceQuantity    Int          @default(0) @map("piece_quantity") // 出库/包
  remark           String?
  createdBy        String       @map("created_by")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  base     Base     @relation(fields: [baseId], references: [id])
  goods    Goods    @relation(fields: [goodsId], references: [id])
  location Location @relation(fields: [locationId], references: [id])
  creator  User     @relation("StockOutCreator", fields: [createdBy], references: [id])

  @@index([baseId])
  @@index([date])
  @@index([goodsId])
  @@index([type])
  @@index([locationId])
  @@index([relatedOrderId])
  @@index([baseId, date])
  @@map("stock_outs")
}

model AnchorProfit {
  id               String            @id @default(uuid())
  locationId       Int               @map("location_id")
  consumptionId    String?           @unique @map("consumption_id")
  profitDate       DateTime          @map("profit_date") @db.Date
  gmvAmount        Decimal           @default(0) @map("gmv_amount") @db.Decimal(12, 2)
  refundAmount     Decimal           @default(0) @map("refund_amount") @db.Decimal(12, 2)
  offlineAmount    Decimal           @default(0) @map("offline_amount") @db.Decimal(12, 2)
  consumptionValue Decimal           @default(0) @map("consumption_value") @db.Decimal(12, 2)
  adCost           Decimal           @default(0) @map("ad_cost") @db.Decimal(12, 2)
  platformFeeRate  Decimal           @default(0) @map("platform_fee_rate") @db.Decimal(5, 2)
  platformFee      Decimal           @default(0) @map("platform_fee") @db.Decimal(12, 2)
  dailySales       Decimal           @default(0) @map("daily_sales") @db.Decimal(12, 2)
  profitAmount     Decimal           @default(0) @map("profit_amount") @db.Decimal(12, 2)
  profitRate       Decimal           @default(0) @map("profit_rate") @db.Decimal(5, 2)
  notes            String?
  createdBy        String            @map("created_by")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  creator          User              @relation("AnchorProfitCreator", fields: [createdBy], references: [id])
  location         Location          @relation(fields: [locationId], references: [id])
  consumption      StockConsumption? @relation(fields: [consumptionId], references: [id])

  @@unique([locationId, profitDate])
  @@index([locationId])
  @@index([profitDate])
  @@index([consumptionId])
  @@map("anchor_profits")
}

model Payable {
  id              String           @id @default(uuid())
  purchaseOrderId String           @map("purchase_order_id")
  supplierName    String           @map("supplier_name")
  totalAmount     Decimal          @map("total_amount") @db.Decimal(12, 2)
  paidAmount      Decimal          @default(0) @map("paid_amount") @db.Decimal(12, 2)
  pendingAmount   Decimal          @map("pending_amount") @db.Decimal(12, 2)
  dueDate         DateTime?        @map("due_date") @db.Date
  notes           String?
  createdBy       String           @map("created_by")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  payments        PayablePayment[]
  creator         User             @relation("PayableCreator", fields: [createdBy], references: [id])
  purchaseOrder   PurchaseOrder    @relation(fields: [purchaseOrderId], references: [id])

  @@index([purchaseOrderId])
  @@index([supplierName])
  @@index([dueDate])
  @@map("payables")
}

model PayablePayment {
  id            String   @id @default(uuid())
  payableId     String   @map("payable_id")
  paymentAmount Decimal  @map("payment_amount") @db.Decimal(12, 2)
  paymentDate   DateTime @map("payment_date") @db.Date
  paymentMethod String?  @map("payment_method")
  notes         String?
  createdBy     String   @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at")
  creator       User     @relation("PayablePaymentCreator", fields: [createdBy], references: [id])
  payable       Payable  @relation(fields: [payableId], references: [id], onDelete: Cascade)

  @@index([payableId])
  @@index([paymentDate])
  @@map("payable_payments")
}

model Translation {
  id            String              @id @default(uuid())
  key           String
  language      String
  value         String
  namespace     String?
  description   String?
  isSystem      Boolean             @default(false) @map("is_system")
  isAiGenerated Boolean             @default(false) @map("is_ai_generated")
  reviewStatus  String              @default("pending") @map("review_status")
  createdAt     DateTime            @default(now()) @map("created_at")
  updatedAt     DateTime            @updatedAt @map("updated_at")
  createdBy     String?             @map("created_by")
  updatedBy     String?             @map("updated_by")
  reviews       TranslationReview[]
  creator       User?               @relation("TranslationCreator", fields: [createdBy], references: [id])
  updater       User?               @relation("TranslationUpdater", fields: [updatedBy], references: [id])

  @@unique([key, language])
  @@index([key])
  @@index([language])
  @@index([namespace])
  @@index([reviewStatus])
  @@map("translations")
}

model TranslationReview {
  id            String      @id @default(uuid())
  translationId String      @map("translation_id")
  reviewerId    String      @map("reviewer_id")
  status        String
  comment       String?
  createdAt     DateTime    @default(now()) @map("created_at")
  reviewer      User        @relation("TranslationReviewer", fields: [reviewerId], references: [id])
  translation   Translation @relation(fields: [translationId], references: [id], onDelete: Cascade)

  @@index([translationId])
  @@index([reviewerId])
  @@index([status])
  @@map("translation_reviews")
}

model casbin_rule {
  id         Int       @id @default(autoincrement())
  ptype      String    @db.VarChar(100)
  v0         String    @default("") @db.VarChar(100)
  v1         String    @default("") @db.VarChar(100)
  v2         String    @default("") @db.VarChar(100)
  v3         String?   @db.VarChar(100)
  v4         String?   @db.VarChar(100)
  v5         String?   @db.VarChar(100)
  created_at DateTime? @default(now()) @db.Timestamp(6)

  @@unique([ptype, v0, v1, v2, v3, v4, v5])
  @@index([ptype], map: "idx_casbin_rule_ptype")
  @@index([v0], map: "idx_casbin_rule_v0")
}

model Base {
  id               Int                @id @default(autoincrement())
  code             String             @unique
  name             String
  // 基地类型：LIVE_BASE(直播基地), OFFLINE_REGION(线下区域)
  type             BaseType           @default(LIVE_BASE)
  description      String?
  address          String?
  contactPerson    String?            @map("contact_person")
  contactPhone     String?            @map("contact_phone")
  contactEmail     String?            @map("contact_email")
  // 货币代码：CNY(人民币), VND(越南盾), THB(泰铢), USD(美元)
  currency         String             @default("CNY")
  // 语言代码：zh-CN(简体中文), zh-TW(繁体中文), vi(越南语), th(泰语), en(英语)
  language         String             @default("zh-CN")
  isActive         Boolean            @default(true) @map("is_active")
  createdBy        String             @map("created_by")
  updatedBy        String             @map("updated_by")
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")
  arrivalRecords   ArrivalRecord[]
  consumptions     StockConsumption[]
  customers        Customer[]
  goods            Goods[]
  inventory        Inventory[]
  inventoryLedgers InventoryLedger[]
  locations        Location[]
  personnel        Personnel[]
  purchaseOrders   PurchaseOrder[]
  supplierBases    SupplierBase[]
  transferRecords  TransferRecord[]
  userBases        UserBase[]
  defaultUsers     User[]             @relation("UserDefaultBase")
  stockOuts        StockOut[]
  // 点位订单系统关联
  points           Point[]
  pointOrders      PointOrder[]

  @@index([code])
  @@index([name])
  @@index([isActive])
  @@map("bases")
}

model UserBase {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  baseId    Int      @map("base_id")
  roles     String[] @default([])
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  base      Base     @relation(fields: [baseId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, baseId])
  @@index([userId])
  @@index([baseId])
  @@index([isActive])
  @@map("user_bases")
}

model Supplier {
  id             String          @id @default(uuid())
  code           String          @unique
  name           String
  contactPerson  String?         @map("contact_person")
  phone          String?
  email          String?
  address        String?
  taxNumber      String?         @map("tax_number")
  bankAccount    String?         @map("bank_account")
  bankName       String?         @map("bank_name")
  notes          String?
  isActive       Boolean         @default(true) @map("is_active")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  supplierBases  SupplierBase[]
  purchaseOrders PurchaseOrder[]

  @@index([code])
  @@index([name])
  @@index([isActive])
  @@map("suppliers")
}

model SupplierBase {
  id            String   @id @default(uuid())
  supplierId    String   @map("supplier_id")
  baseId        Int      @map("base_id")
  isActive      Boolean  @default(true) @map("is_active")
  paymentTerms  String?  @map("payment_terms")
  deliveryTerms String?  @map("delivery_terms")
  creditLimit   Decimal  @default(0) @map("credit_limit") @db.Decimal(12, 2)
  notes         String?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  base          Base     @relation(fields: [baseId], references: [id], onDelete: Cascade)
  supplier      Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([supplierId, baseId])
  @@index([supplierId])
  @@index([baseId])
  @@index([isActive])
  @@map("supplier_bases")
}

model Personnel {
  id                         String             @id @default(uuid())
  code                       String             @unique
  name                       String
  role                       PersonnelRole
  phone                      String?
  email                      String?
  notes                      String?
  baseId                     Int                @map("base_id")
  isActive                   Boolean            @default(true) @map("is_active")
  createdBy                  String?            @map("created_by")
  updatedBy                  String?            @map("updated_by")
  createdAt                  DateTime           @default(now()) @map("created_at")
  updatedAt                  DateTime           @updatedAt @map("updated_at")
  arrivalRecords             ArrivalRecord[]    @relation("ArrivalHandler")
  inventoryLedgers           InventoryLedger[]  @relation("InventoryLedgerHandler")
  consumptions               StockConsumption[] @relation("ConsumptionHandler")
  base                       Base               @relation(fields: [baseId], references: [id], onDelete: Cascade)
  creator                    User?              @relation("PersonnelCreator", fields: [createdBy], references: [id])
  updater                    User?              @relation("PersonnelUpdater", fields: [updatedBy], references: [id])
  transferSourceRecords      TransferRecord[]   @relation("TransferSourceHandler")
  transferDestinationRecords TransferRecord[]   @relation("TransferDestinationHandler")

  @@index([code])
  @@index([name])
  @@index([role])
  @@index([baseId])
  @@index([isActive])
  @@map("personnel")
}

model ArrivalRecord {
  id              String        @id @default(uuid())
  arrivalDate     DateTime      @map("arrival_date") @db.Date
  purchaseOrderId String        @map("purchase_order_id")
  goodsId         String        @map("goods_id")
  locationId      Int           @map("location_id")
  handlerId       String        @map("handler_id")
  baseId          Int           @map("base_id")
  boxQuantity     Int           @default(0) @map("box_quantity")
  packQuantity    Int           @default(0) @map("pack_quantity")
  pieceQuantity   Int           @default(0) @map("piece_quantity")
  notes           String?
  createdBy       String?       @map("created_by")
  updatedBy       String?       @map("updated_by")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  base            Base          @relation(fields: [baseId], references: [id], onDelete: Cascade)
  creator         User?         @relation("ArrivalCreator", fields: [createdBy], references: [id])
  goods           Goods         @relation(fields: [goodsId], references: [id], onDelete: Cascade)
  handler         Personnel     @relation("ArrivalHandler", fields: [handlerId], references: [id], onDelete: Cascade)
  location        Location      @relation(fields: [locationId], references: [id], onDelete: Cascade)
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  updater         User?         @relation("ArrivalUpdater", fields: [updatedBy], references: [id])

  @@index([arrivalDate])
  @@index([purchaseOrderId])
  @@index([goodsId])
  @@index([locationId])
  @@index([handlerId])
  @@index([baseId])
  @@index([createdAt])
  @@map("arrival_records")
}

model TransferRecord {
  id                    String         @id @default(uuid())
  transferDate          DateTime       @map("transfer_date") @db.Date
  goodsId               String         @map("goods_id")
  sourceLocationId      Int            @map("source_location_id")
  sourceHandlerId       String         @map("source_handler_id") // 调出主播
  destinationLocationId Int            @map("destination_location_id")
  destinationHandlerId  String         @map("destination_handler_id") // 调入主播
  baseId                Int            @map("base_id")
  boxQuantity           Int            @default(0) @map("box_quantity")
  packQuantity          Int            @default(0) @map("pack_quantity")
  pieceQuantity         Int            @default(0) @map("piece_quantity")
  status                TransferStatus @default(COMPLETED)
  notes                 String?
  createdBy             String?        @map("created_by")
  updatedBy             String?        @map("updated_by")
  createdAt             DateTime       @default(now()) @map("created_at")
  updatedAt             DateTime       @updatedAt @map("updated_at")
  base                  Base           @relation(fields: [baseId], references: [id], onDelete: Cascade)
  creator               User?          @relation("TransferCreator", fields: [createdBy], references: [id])
  destinationLocation   Location       @relation("TransferDestination", fields: [destinationLocationId], references: [id], onDelete: Cascade)
  destinationHandler    Personnel      @relation("TransferDestinationHandler", fields: [destinationHandlerId], references: [id], onDelete: Cascade)
  goods                 Goods          @relation(fields: [goodsId], references: [id], onDelete: Cascade)
  sourceHandler         Personnel      @relation("TransferSourceHandler", fields: [sourceHandlerId], references: [id], onDelete: Cascade)
  sourceLocation        Location       @relation("TransferSource", fields: [sourceLocationId], references: [id], onDelete: Cascade)
  updater               User?          @relation("TransferUpdater", fields: [updatedBy], references: [id])

  @@index([transferDate])
  @@index([goodsId])
  @@index([sourceLocationId])
  @@index([sourceHandlerId])
  @@index([destinationLocationId])
  @@index([destinationHandlerId])
  @@index([baseId])
  @@index([status])
  @@index([createdAt])
  @@map("transfer_records")
}

model InventoryLedger {
  id                String    @id @default(uuid())
  date              DateTime  @db.Date
  goodsId           String    @map("goods_id")
  locationId        Int       @map("location_id")
  handlerId         String    @map("handler_id")
  baseId            Int       @map("base_id")
  openingStockBox   Int       @default(0) @map("opening_stock_box")
  openingStockPack  Int       @default(0) @map("opening_stock_pack")
  openingStockPiece Int       @default(0) @map("opening_stock_piece")
  closingStockBox   Int       @default(0) @map("closing_stock_box")
  closingStockPack  Int       @default(0) @map("closing_stock_pack")
  closingStockPiece Int       @default(0) @map("closing_stock_piece")
  arrivalBox        Int       @default(0) @map("arrival_box")
  arrivalPack       Int       @default(0) @map("arrival_pack")
  arrivalPiece      Int       @default(0) @map("arrival_piece")
  transferInBox     Int       @default(0) @map("transfer_in_box")
  transferInPack    Int       @default(0) @map("transfer_in_pack")
  transferInPiece   Int       @default(0) @map("transfer_in_piece")
  transferOutBox    Int       @default(0) @map("transfer_out_box")
  transferOutPack   Int       @default(0) @map("transfer_out_pack")
  transferOutPiece  Int       @default(0) @map("transfer_out_piece")
  consumptionBox    Int       @default(0) @map("consumption_box")
  consumptionPack   Int       @default(0) @map("consumption_pack")
  consumptionPiece  Int       @default(0) @map("consumption_piece")
  consumptionValue  Decimal   @default(0) @map("consumption_value") @db.Decimal(12, 2)
  notes             String?
  createdBy         String?   @map("created_by")
  updatedBy         String?   @map("updated_by")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  base              Base      @relation(fields: [baseId], references: [id], onDelete: Cascade)
  creator           User?     @relation("InventoryLedgerCreator", fields: [createdBy], references: [id])
  goods             Goods     @relation(fields: [goodsId], references: [id], onDelete: Cascade)
  handler           Personnel @relation("InventoryLedgerHandler", fields: [handlerId], references: [id], onDelete: Cascade)
  location          Location  @relation("InventoryLedgerLocation", fields: [locationId], references: [id], onDelete: Cascade)
  updater           User?     @relation("InventoryLedgerUpdater", fields: [updatedBy], references: [id])

  @@unique([date, goodsId, locationId, handlerId])
  @@index([date])
  @@index([goodsId])
  @@index([locationId])
  @@index([handlerId])
  @@index([baseId])
  @@index([createdAt])
  @@map("inventory_ledger")
}

enum BaseType {
  LIVE_BASE // 直播基地
  OFFLINE_REGION // 线下区域
}

enum LocationType {
  MAIN_WAREHOUSE
  WAREHOUSE
  LIVE_ROOM
}

enum PersonnelRole {
  ANCHOR
  WAREHOUSE_KEEPER
}

enum TransferStatus {
  PENDING
  COMPLETED
  CANCELLED
}

// ==================== 点位订单系统 ====================

// 点位订单状态
enum PointOrderStatus {
  PENDING // 待处理（老板下单后）
  CONFIRMED // 已确认（客服确认）
  SHIPPING // 配送中（已发货）
  DELIVERED // 已送达
  COMPLETED // 已完成（货物入点位库存）
  CANCELLED // 已取消
}

// 付款状态
enum PaymentStatus {
  UNPAID // 未付款
  PARTIAL // 部分付款
  PAID // 已付款
}

// 点位（线下门店）
model Point {
  id            String   @id @default(uuid())
  code          String   @unique // 点位编号：POINT-XXXXXXXXXXX
  name          String // 店铺名称
  address       String? // 详细地址
  contactPerson String?  @map("contact_person") // 联系人
  contactPhone  String?  @map("contact_phone") // 联系电话
  baseId        Int      @map("base_id") // 所属大区
  ownerId       String?  @map("owner_id") // 点位老板（用户ID）
  dealerId      String?  @map("dealer_id") // 经销商（用户ID）
  notes         String?
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  base           Base             @relation(fields: [baseId], references: [id])
  owner          User?            @relation("PointOwner", fields: [ownerId], references: [id])
  dealer         User?            @relation("PointDealer", fields: [dealerId], references: [id])
  pointOrders    PointOrder[]
  pointInventory PointInventory[]
  pointGoods     PointGoods[] // 该点位可采购的商品列表

  @@index([code])
  @@index([name])
  @@index([baseId])
  @@index([ownerId])
  @@index([dealerId])
  @@index([isActive])
  @@map("points")
}

// 点位可采购商品
model PointGoods {
  id             String   @id @default(uuid())
  pointId        String   @map("point_id")
  goodsId        String   @map("goods_id")
  maxBoxQuantity Int?     @map("max_box_quantity") // 最大可采购箱数（null表示不限制）
  maxPackQuantity Int?    @map("max_pack_quantity") // 最大可采购盒数（null表示不限制）
  unitPrice      Decimal? @map("unit_price") @db.Decimal(12, 2) // 该点位的专属单价（箱），null则使用商品默认价格
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  point Point @relation(fields: [pointId], references: [id], onDelete: Cascade)
  goods Goods @relation(fields: [goodsId], references: [id], onDelete: Cascade)

  @@unique([pointId, goodsId])
  @@index([pointId])
  @@index([goodsId])
  @@map("point_goods")
}

// 点位订单
model PointOrder {
  id          String           @id @default(uuid())
  code        String           @unique // 订单编号：PTO-XXXXXXXXXXX
  pointId     String           @map("point_id") // 下单点位
  baseId      Int              @map("base_id") // 所属大区
  orderDate   DateTime         @map("order_date") @db.Date
  totalAmount Decimal          @default(0) @map("total_amount") @db.Decimal(12, 2)
  status      PointOrderStatus @default(PENDING)

  // 付款信息（人工编辑）
  paymentStatus PaymentStatus @default(UNPAID) @map("payment_status")
  paidAmount    Decimal       @default(0) @map("paid_amount") @db.Decimal(12, 2)
  paymentNotes  String?       @map("payment_notes") // 付款备注

  // 配送信息
  shippingAddress String? @map("shipping_address")
  shippingPhone   String? @map("shipping_phone")
  trackingNumber  String? @map("tracking_number") // 物流单号
  deliveryPerson  String? @map("delivery_person") // 送货员
  deliveryPhone   String? @map("delivery_phone") // 送货员电话

  // 时间节点
  confirmedAt DateTime? @map("confirmed_at") // 客服确认时间
  shippedAt   DateTime? @map("shipped_at") // 发货时间
  deliveredAt DateTime? @map("delivered_at") // 送达时间
  completedAt DateTime? @map("completed_at") // 完成时间
  cancelledAt DateTime? @map("cancelled_at") // 取消时间

  notes         String? // 订单备注
  customerNotes String? @map("customer_notes") // 客户备注
  staffNotes    String? @map("staff_notes") // 客服备注

  createdBy   String   @map("created_by") // 下单人
  confirmedBy String?  @map("confirmed_by") // 确认人（客服）
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  point     Point            @relation(fields: [pointId], references: [id])
  base      Base             @relation(fields: [baseId], references: [id])
  creator   User             @relation("PointOrderCreator", fields: [createdBy], references: [id])
  confirmer User?            @relation("PointOrderConfirmer", fields: [confirmedBy], references: [id])
  items     PointOrderItem[]

  @@index([code])
  @@index([pointId])
  @@index([baseId])
  @@index([status])
  @@index([paymentStatus])
  @@index([orderDate])
  @@index([createdBy])
  @@map("point_orders")
}

// 点位订单明细
model PointOrderItem {
  id           String @id @default(uuid())
  pointOrderId String @map("point_order_id")
  goodsId      String @map("goods_id")

  // 订购数量（以盒为最小单位）
  boxQuantity  Int @default(0) @map("box_quantity")
  packQuantity Int @default(0) @map("pack_quantity") // 盒数

  // 单价和总价
  unitPrice  Decimal @map("unit_price") @db.Decimal(12, 2) // 单价/盒
  totalPrice Decimal @map("total_price") @db.Decimal(12, 2)

  // 实际发货数量（客服可调整）
  actualBoxQty  Int? @map("actual_box_qty")
  actualPackQty Int? @map("actual_pack_qty")

  notes String?

  pointOrder PointOrder @relation(fields: [pointOrderId], references: [id], onDelete: Cascade)
  goods      Goods      @relation(fields: [goodsId], references: [id])

  @@index([pointOrderId])
  @@index([goodsId])
  @@map("point_order_items")
}

// 点位库存
model PointInventory {
  id      String @id @default(uuid())
  pointId String @map("point_id")
  goodsId String @map("goods_id")

  // 库存数量
  boxQuantity   Int @default(0) @map("box_quantity")
  packQuantity  Int @default(0) @map("pack_quantity")
  pieceQuantity Int @default(0) @map("piece_quantity")

  updatedAt DateTime @updatedAt @map("updated_at")

  point Point @relation(fields: [pointId], references: [id], onDelete: Cascade)
  goods Goods @relation(fields: [goodsId], references: [id], onDelete: Cascade)

  @@unique([pointId, goodsId])
  @@index([pointId])
  @@index([goodsId])
  @@map("point_inventory")
}

// ============================================
// Casbin 权限系统相关模型
// ============================================

/// Casbin 策略存储表
model CasbinRule {
  id    Int     @id @default(autoincrement())
  ptype String // 策略类型: p (policy) 或 g (grouping)
  v0    String? // 角色/用户
  v1    String? // 域(基地ID) 或 角色
  v2    String? // 资源 或 域
  v3    String? // 操作
  v4    String? // 效果 (allow/deny)
  v5    String? // 保留字段

  @@index([ptype])
  @@index([v0])
  @@index([v1])
  @@map("casbin_rules")
}

/// 数据权限规则表
model DataPermissionRule {
  id     String @id @default(uuid())
  roleId String @map("role_id")

  resource   String // 资源类型: point, order, inventory
  field      String // 过滤字段: ownerId, dealerId, createdBy
  operator   String // 操作符: eq, in, contains
  valueType  String  @map("value_type") // 值类型: currentUser, currentUserPoints, fixed
  fixedValue String? @map("fixed_value") // 固定值（当 valueType 为 fixed 时）

  description String? // 规则描述
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, resource, field])
  @@index([roleId])
  @@index([resource])
  @@index([isActive])
  @@map("data_permission_rules")
}

/// 字段权限表（控制哪些字段可见/可编辑）
model FieldPermission {
  id     String @id @default(uuid())
  roleId String @map("role_id")

  resource String // 资源类型
  field    String // 字段名
  canRead  Boolean @default(true) @map("can_read")
  canWrite Boolean @default(true) @map("can_write")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, resource, field])
  @@index([roleId])
  @@index([resource])
  @@map("field_permissions")
}
