# Excel导入去重功能说明

## 🎯 功能概述

Excel导入功能已添加**自动去重机制**，避免重复数据导入。

---

## ✅ 商品导入去重规则

### **去重依据**
```
唯一键 = 商品名称（基地内唯一）
```

**说明**：
- ✅ 同一基地内，商品名称不允许重复
- ✅ 不同基地间，允许存在相同名称的商品（数据已按基地隔离）
- ✅ 不对比厂家名称，简化判断逻辑

### **示例**
| 基地 | 商品名称 | 是否重复 |
|-----|---------|---------|
| 基地A | 名侦探柯南挂件-星绽版-第1弹 | ✅ 唯一 |
| 基地A | 名侦探柯南挂件-星绽版-第1弹 | ❌ 重复（跳过） |
| 基地B | 名侦探柯南挂件-星绽版-第1弹 | ✅ 唯一（不同基地） |

### **处理逻辑**
1. **导入前检查**：获取当前基地所有商品（自动按baseId隔离）
2. **构建去重Map**：`商品名称` → 商品ID
3. **逐行验证**：
   - 已存在 → 跳过，记录到跳过列表
   - 不存在 → 创建新商品
4. **批次内去重**：同一Excel文件内的重复数据也会被跳过

---

## 📊 导入结果提示

### **全部成功**
```
✅ 导入完成！成功导入 50 条商品
```

### **有跳过/失败**
```
⚠️ 导入完成

成功导入：45 条
跳过重复：3 条
失败：2 条

跳过的重复数据：
第3行：名侦探柯南挂件-星绽版-第1弹
第8行：卡游柯南揭秘包1元包
第15行：灵魂重生收藏卡

失败详情：
第10行：商品A - 零售价必须大于0
第20行：商品B - 网络错误
```

---

## 🔧 技术实现

### **核心代码**
```typescript
// 1. 获取现有商品
const existingGoods = await request(`/api/v1/bases/${baseId}/goods`, {
  method: 'GET',
  params: { page: 1, pageSize: 10000 },
});

// 2. 构建去重Map（仅商品名称）
const existingMap = new Map<string, string>();
existingGoods.data.forEach((goods: any) => {
  existingMap.set(goods.name, goods.id);
});

// 3. 检查重复
for (const item of importData) {
  if (existingMap.has(item.name)) {
    // 跳过重复
    skipCount++;
    skippedItems.push(`第${i + 2}行：${item.name}`);
    continue;
  }
  
  // 创建新商品
  await createGoods(item);
  
  // 添加到Map，避免批次内重复
  existingMap.set(item.name, newId);
}
```

---

## 📋 导入说明（用户界面）

```
1. 请使用提供的模板文件，保持列名不变
2. ID、商品编号、创建时间由系统自动生成，导入时会被忽略
3. 商品名称、厂家名称、零售价、盒/箱、包/盒为必填项
4. 箱数量固定为1，无需填写
5. 自动去重：相同"商品名称"的数据会被自动跳过（基地内唯一）
6. 支持批量导入，建议每次不超过500条
```

---

## 🎯 其他页面去重规则（待实现）

### **采购导入**
```
唯一键 = 采购日期 + 供应商 + 商品名称
```
- 同一天、同一供应商、同一商品的采购记录视为重复

### **到货导入**
```
唯一键 = 到货日期 + 采购编号 + 商品编号
```
- 同一天、同一采购单、同一商品的到货记录视为重复

### **调货导入**
```
唯一键 = 调货日期 + 源位置 + 目标位置 + 商品编号
```
- 同一天、同一调货路径、同一商品的调货记录视为重复

### **消耗导入**
```
唯一键 = 消耗日期 + 直播间 + 商品编号
```
- 同一天、同一直播间、同一商品的消耗记录视为重复

---

## ✨ 优势

1. **防止数据冗余** - 避免重复导入相同商品
2. **智能提示** - 明确告知哪些数据被跳过
3. **批次内去重** - 同一Excel文件内的重复也会处理
4. **性能优化** - 一次性获取所有数据，构建Map快速查找
5. **用户友好** - 详细的跳过列表，方便核对

---

## 🔄 后续优化建议

1. **可选去重模式**
   - 跳过重复（当前）
   - 更新重复
   - 全部新增

2. **自定义去重规则**
   - 允许用户选择去重字段组合

3. **去重报告导出**
   - 导出跳过的数据为Excel文件

---

**商品导入去重功能已完成！** ✅
