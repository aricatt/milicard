# 数据转换工具

## 数据迁移工具

这是一个数据转换工具，用于将旧系统的聚合CSV数据拆分转换为新ERP系统可导入的独立表格。

**重要说明**：本工具只进行数据转换，不会自动导入数据库。转换后的数据需要通过系统界面按顺序手动导入。

## 功能特点

- ✅ 读取旧系统CSV文件（自动处理GBK/GB18030编码）
- ✅ 将聚合数据拆分成独立的导入表
- ✅ 提取并分离品类、供应商、商品等实体
- ✅ 生成符合系统导入格式的CSV文件
- ✅ 自动生成导入顺序说明文档
- ✅ 数据清洗和格式转换
- ❌ 不包含自动数据库导入功能

## 核心里念

老数据是**聚合结构**（一个CSV包含多种信息），新系统是**分散结构**（每个实体独立存储）。
本工具的作用是将聚合数据拆分成符合系统依赖关系的独立导入表。
- ❌ **不会**自动连接数据库
- ❌ **不会**自动导入数据

## 数据映射关系

### 1. 商品数据 (SKU.CSV)
- **源文件**: `SKU.CSV`
- **目标表**: `Goods` (全局商品表)
- **映射关系**:
  - sku序列 → code
  - 中文名 → name
  - 英文/越文名 → nameI18n (JSON)
  - 品类 → categoryId (需要先创建品类)
  - 厂商 → manufacturer
  - 盒/箱 → packPerBox
  - 包/盒 → piecePerPack

### 2. 采购记录 (采购管理-采购记录.CSV)
- **源文件**: `采购管理-采购记录.CSV`
- **目标表**: `PurchaseOrder` (采购订单)
- **映射关系**:
  - 采购单号 → code
  - 供货商 → supplierName
  - 产品名称 → 关联到 Goods
  - 采购数量 → boxQuantity
  - 单价 → unitPrice
  - 下单时间 → orderDate

### 3. 入库记录 (入库.CSV)
- **源文件**: `入库.CSV`
- **目标表**: `ArrivalRecord` (到货记录)
- **映射关系**:
  - sku序列 → goodsId
  - 仓库名 → locationId
  - 入库人 → createdBy
  - 入库时间 → arrivalDate
  - 箱数 → boxQuantity

### 4. 出库记录 (出库.CSV)
- **源文件**: `出库.CSV`
- **目标表**: `StockOut` (出库记录)
- **映射关系**:
  - sku序列 → goodsId
  - 数量/盒 → boxQuantity
  - 主播 → 关联到 Personnel
  - 出库日期 → date

### 5. 调货记录 (调货.CSV)
- **源文件**: `调货.CSV`
- **目标表**: `TransferRecord` (调货记录)
- **映射关系**:
  - sku序列 → goodsId
  - 从主播 → sourceLocationId
  - 到主播 → destinationLocationId
  - 调货日期 → transferDate

### 6. 主播库存 (主播库存.CSV)
- **源文件**: `主播库存.CSV`
- **目标表**: `StockConsumption` (库存消耗)
- **映射关系**:
  - SKU → goodsId
  - 主播 → 关联到 Personnel
  - 销售数量 → 消耗数量

### 7. 人员数据 (主播和运营.CSV)
- **源文件**: `主播和运营.CSV`
- **目标表**: `Personnel` (人员管理)
- **需要手动处理或提供更多信息**

## 使用步骤

### 1. 安装依赖

```bash
cd scripts/data-migration
npm install
```

### 2. 检查原始数据（可选）

```bash
npm run inspect
```

这会显示原始CSV文件的编码、行数、列名等信息。

### 3. 运行数据拆分转换

```bash
npm run convert:import
```

这会将聚合的老数据拆分成10个独立的导入表：

**输出文件** (`output/converted/` 目录)：
1. `01_商品品类导入表.csv` - 商品品类（从品类字段提取并分离中英文）
2. `02_供应商导入表.csv` - 供应商（从采购记录和商品厂商提取）
3. `03_全局商品导入表.csv` - 全局商品（包含品类关联）
4. `04_直播间仓库导入表.csv` - 直播间和仓库（从各类记录中提取）
5. `05_主播运营导入表.csv` - 主播、运营、仓管人员
6. `06_基地级商品设置导入表.csv` - 商品价格设置（需手动填写价格）
7. `07_采购订单导入表.csv` - 采购订单
8. `08_到货记录导入表.csv` - 到货记录
9. `09_出库记录导入表.csv` - 出库记录
10. `10_调货记录导入表.csv` - 调货记录
11. `导入顺序说明.md` - 详细的导入说明文档

### 4. 人工复查和补充数据

**重要**：打开生成的CSV文件，进行以下操作：

1. **检查数据完整性**：确认所有必要数据都已提取
2. **补充联系信息**：供应商和人员的联系方式需要手动补充
3. **填写商品价格**：`06_基地级商品设置导入表.csv` 中的价格必须手动填写
   - 格式：`[VND]22356` 或 `[CNY]5600`
4. **统一日期格式**：建议统一为 `YYYY-MM-DD` 格式
5. **检查名称匹配**：确保人员、地点、商品名称在各表中一致

### 5. 按顺序导入数据

**严格按照以下顺序**通过系统界面导入：

1. **商品品类** → 全局信息 > 商品品类
2. **供应商** → 基地管理 > 供应商
3. **全局商品** → 全局信息 > 所有商品
4. **直播间/仓库** → 基地管理 > 直播间/仓库
5. **主播/运营** → 基地管理 > 主播/仓管
6. **商品设置** → 基地管理 > 商品管理（填写价格后）
7. **采购订单** → 基地管理 > 采购管理
8. **到货记录** → 基地管理 > 到货管理
9. **出库记录** → 基地管理 > 出库管理
10. **调货记录** → 基地管理 > 调货管理

详细说明请查看生成的 `导入顺序说明.md` 文档。

## 注意事项

### ⚠️ 重要警告

1. **数据不可逆**: 导入后的数据无法自动回滚，请务必备份
2. **编码问题**: CSV 文件包含越南语，确保使用 UTF-8 编码
3. **日期格式**: 旧数据日期格式为 `2025.10.15`，需要转换
4. **关联数据**: 某些数据需要先导入依赖数据（如先导入商品，再导入采购记录）

### 🔧 数据清洗规则

1. **SKU 编号**: 保持原有编号，作为商品 code
2. **人员匹配**: 通过姓名匹配到系统中的 Personnel
3. **仓库匹配**: 通过仓库名称匹配到 Location
4. **缺失数据**: 使用默认值或跳过记录

### 📝 导入顺序

**必须按以下顺序导入**:

1. 品类 (Category) - 从 SKU 中提取
2. 商品 (Goods) - SKU.CSV
3. 人员 (Personnel) - 主播和运营.CSV
4. 采购订单 (PurchaseOrder) - 采购管理-采购记录.CSV
5. 到货记录 (ArrivalRecord) - 入库.CSV
6. 出库记录 (StockOut) - 出库.CSV
7. 调货记录 (TransferRecord) - 调货.CSV
8. 库存消耗 (StockConsumption) - 主播库存.CSV

## 故障排查

### 常见问题

1. **编码错误**: 使用 `iconv` 转换文件编码
   ```bash
   iconv -f GB18030 -t UTF-8 input.csv > output.csv
   ```

2. **日期解析失败**: 检查日期格式是否为 `YYYY.MM.DD`

3. **关联数据找不到**: 检查是否已导入依赖数据

4. **重复数据**: 脚本会自动跳过已存在的记录（根据 code 判断）

## 数据验证

导入完成后，执行以下 SQL 验证数据：

```sql
-- 检查商品数量
SELECT COUNT(*) FROM goods;

-- 检查采购订单
SELECT COUNT(*) FROM purchase_orders;

-- 检查到货记录
SELECT COUNT(*) FROM arrival_records;

-- 检查出库记录
SELECT COUNT(*) FROM stock_outs;

-- 检查调货记录
SELECT COUNT(*) FROM transfer_records;
```

## 回滚方案

如果导入出现问题，可以恢复备份：

```bash
# 恢复数据库
psql -U postgres -d milicard < backup_20250105.sql
```
